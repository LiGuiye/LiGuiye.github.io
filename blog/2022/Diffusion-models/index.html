<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Diffusion models | Guiye  Li</title>
    <meta name="author" content="Guiye  Li">
    <meta name="description" content="">
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://localhost:4000/blog/2022/Diffusion-models/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Guiye </span>Li</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/">repositories</a>
              </li>
              <li class="nav-item dropdown ">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">unfinished</a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/cv/">cv</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="/projects/">projects</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="/teaching/">teaching</a>
                </div>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Diffusion models</h1>
    <p class="post-meta">December 14, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
        ·  
        <a href="/blog/category/generative-model">
          <i class="fas fa-tag fa-sm"></i> generative-model</a>  
          <a href="/blog/category/deep-learning">
          <i class="fas fa-tag fa-sm"></i> deep-learning</a>  
          <a href="/blog/category/diffusion-model">
          <i class="fas fa-tag fa-sm"></i> diffusion-model</a>  
          

    </p>
  </header>

  <article class="post-content">
    <p><em>TOC</em></p>

<ul id="markdown-toc">
  <li><a href="#markov-chain" id="markdown-toc-markov-chain">Markov chain</a></li>
  <li>
<a href="#main-idea-of-diffusion-model" id="markdown-toc-main-idea-of-diffusion-model">Main idea of Diffusion Model</a>    <ul>
      <li><a href="#forward-process-or-diffusion-process" id="markdown-toc-forward-process-or-diffusion-process"><em>Forward process</em> (or <em>diffusion process</em>)</a></li>
      <li><a href="#reverse-process-or-reverse-diffusion-process" id="markdown-toc-reverse-process-or-reverse-diffusion-process"><em>Reverse process</em> (or <em>reverse diffusion process</em>)</a></li>
    </ul>
  </li>
  <li><a href="#benefits-of-diffusion-models" id="markdown-toc-benefits-of-diffusion-models">Benefits of Diffusion Models</a></li>
  <li><a href="#training" id="markdown-toc-training">Training</a></li>
  <li><a href="#summary" id="markdown-toc-summary">Summary</a></li>
</ul>

<p><em>Reference:</em></p>

<p>Official links:</p>

<ol>
  <li>
    <p>DDPM (NeurIPS 2020)</p>

    <p>Paper: <a href="https://arxiv.org/abs/2006.11239" rel="external nofollow noopener" target="_blank">Denoising Diffusion Probabilistic Models</a></p>

    <p>Github: <a href="https://github.com/hojonathanho/diffusion" rel="external nofollow noopener" target="_blank">https://github.com/hojonathanho/diffusion</a></p>

    <p>Website: <a href="https://hojonathanho.github.io/diffusion/" rel="external nofollow noopener" target="_blank">https://hojonathanho.github.io/diffusion/</a></p>
  </li>
  <li>
    <p>Improved DDPM (ICML 2021)</p>

    <p>Paper: <a href="https://arxiv.org/abs/2102.09672" rel="external nofollow noopener" target="_blank">Improved Denoising Diffusion Probabilistic Models</a></p>

    <p>Github: <a href="https://github.com/openai/improved-diffusion" rel="external nofollow noopener" target="_blank">https://github.com/openai/improved-diffusion</a></p>
  </li>
  <li>
    <p>Guided Diffusion Models (NeurIPS 2021)</p>

    <p>Paper: <a href="https://arxiv.org/pdf/2105.05233.pdf" rel="external nofollow noopener" target="_blank">Diffusion Models Beat GANs on Image Synthesis</a></p>

    <p>Github: <a href="https://github.com/openai/guided-diffusion" rel="external nofollow noopener" target="_blank">https://github.com/openai/guided-diffusion</a></p>
  </li>
</ol>

<p>Blog:</p>

<ol>
  <li><a href="https://www.assemblyai.com/blog/diffusion-models-for-machine-learning-introduction/" rel="external nofollow noopener" target="_blank">Introduction to Diffusion Models for Machine Learning</a></li>
  <li><a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/" rel="external nofollow noopener" target="_blank">What are Diffusion Models?</a></li>
</ol>

<h2 id="markov-chain">Markov chain</h2>

<p>Quote from <a href="https://en.wikipedia.org/wiki/Markov_chain#:~:text=A%20Markov%20chain%20or%20Markov,the%20state%20of%20affairs%20now.%22" rel="external nofollow noopener" target="_blank">Wikipedia</a>:</p>

<p>A <strong>Markov chain</strong> or <strong>Markov process</strong> is a stochastic model describing a sequence of possible events in which the probability of each event depends only on the state attained in the previous event. Informally, this may be thought of as, “What happens next depends only on the state of affairs now”.</p>

<h2 id="main-idea-of-diffusion-model">Main idea of Diffusion Model</h2>

<p>Diffusion models works by <strong>destroying training data</strong> through the successive addition if Gaussian noise, and then <strong>learning to recover</strong> the data by reversing this noising process. After training, we can use the Diffusion Model to generate data by simply <strong>passing randomly sampled noise through the learned denoising process</strong>.</p>

<h3 id="forward-process-or-diffusion-process">
<em>Forward process</em> (or <em>diffusion process</em>)</h3>

<p>Specifically, a Diffusion Model is a latent variable model which maps to the latent space using a fixed Markov chain. This chain gradually adds noise to the data in order to obtain the <strong>approximate posterior</strong> \(q(X_{1:T}\vert X_0)\), where \(X_1,\ldots,X_T\) are the latent variables with the same dimensionality as \(X_0\). See figure below.</p>

<p><img src="https://www.assemblyai.com/blog/content/images/size/w1000/2022/05/image.png" alt="The Markov chain manifested for image data." width="600pt"></p>

<p>A parameterization of the forward process (combing Markov assumption):</p>

<p>\begin{equation}
\label{eq:forward-process}
q(X_{1:T} \vert X_0) := \prod^T_{t=1} q(X_t \vert X_{t-1}) := \prod^T_{t=1} \mathcal{N}(X_t;\sqrt{1-\beta_t}X_{t-1},\beta_t\mathbf{I})
\end{equation}</p>

<p>where \(\beta_1,\dots,\beta_T\) is a variance schedule (either learned or fixed) which, if well-behaved, <strong>ensures that \(X_T\) is nearly an isotropic Gaussian for sufficiently large \(T\)</strong>.</p>

<p><em>Let’s skip the proof for now.</em></p>

<h3 id="reverse-process-or-reverse-diffusion-process">
<em>Reverse process</em> (or <em>reverse diffusion process</em>)</h3>

<p>Ultimately, the image is asymptotically transformed to pure Gaussian noise. The goal of training a diffusion model is to <strong>learn the reverse process</strong>, i.e. training \(p_\theta (X_{t-1} \vert X_t)\). See figure below, by traversing backwards along this chain, we can generate new data.</p>

<p><img src="https://www.assemblyai.com/blog/content/images/size/w1000/2022/05/image-1.png" alt="The reverse process of the Markov chain." width="600pt"></p>

<p>Starting with the pure Gaussian noise \(p(X_T)=\mathcal{N}(X_T;\mathbf{0},\mathbf{I})\), the model learns the joint distribution \(p_\theta(X_0;T)\) as:</p>

<p>\begin{equation}
p_\theta(X_0;T) := p(X_T) \prod^T_{t=1} p_\theta(X_{t-1}\vert X_t) := p(X_T) \prod^T_{t=1} \mathcal{N}(X_{t-1};\mu_\theta(x_t,t),\varSigma_\theta(X_t,t))
\end{equation}</p>

<p>where the time-dependent parameters of the Gaussian transitions are learned.</p>

<h2 id="benefits-of-diffusion-models">Benefits of Diffusion Models</h2>

<ol>
  <li>Diffusion Models currently produce State-of-the-Art image quality.</li>
  <li>Not requiring adversarial training.</li>
  <li>Scalability and parallelizability.</li>
</ol>

<h2 id="training">Training</h2>

<p>A Diffusion Model is trained by <strong>finding the reverse Markov transitions that maximize the likelihood of the training data</strong>. In practice, training equivalently consists of minimizing the variational upper bound on the negative log likelihood.</p>

<p>\begin{equation}
\mathbb{E} [- \log p_\theta (X_0)] \leqslant \mathbb{E}_ {q} [-\log \frac{p_\theta (X_{0:T})}{q(X_{1:T} \vert X_0)}] =: L_{vlb}
\end{equation}</p>

<p>Variational lower bound \(L_{vlb}\) is technically an upper bound (the negative of the ELBO) which we are trying to minimize. We will try to rewrite the \(L_{vlb}\) in terms of Kullback-Leibler (KL) Divergences because the transition distributions in the Markov chain are Gaussians, and <strong>the KL divergence between Gaussians has a closed form</strong>.</p>

<p>\begin{equation}
D_{KL}(P\parallel Q) = \int_{-\infty}^{\infty} p(x)\log(\frac{p(x)}{q(x)}) dx
\end{equation}</p>

<p>Casting \(L_{vlb}\) in terms of KL Divergences</p>

<p>\begin{equation}
L_{vlb} := L_0 + L_1 + \ldots + L_{T-1} + L_T
\end{equation}</p>

<p>where</p>

<p>\begin{equation}
L_0 := -\log p_\theta(X_0 \vert X_1)
\end{equation}</p>

<p>\begin{equation}
L_{t-1} := D_{KL}(q(X_{t-1} \vert X_t,X_0)\parallel p_\theta(X_{t-1} \vert X_t))
\end{equation}</p>

<p>\begin{equation}
L_T := D_{KL}(q(X_T \vert X_0)\parallel p(X_T))
\end{equation}</p>

<p><em>Let’s skip the proof for now.</em></p>

<p>Conditioning the forward process posterior on \(X_0\) in \(L_{t-1}\) results in a tractable form that leads to <strong>all KL divergences being comparisons between Gaussians</strong>. This means that the divergences can be exactly calculated with closed-form expressions rather than with Monte Carlo estimates.</p>

<h2 id="summary">Summary</h2>

<ol>
  <li>Diffusion Models are <strong>highly flexible</strong> and allow for any architecture whose input and output dimensionality are the same to be used. Many implementations use <strong>U-Net-like</strong> architectures.</li>
  <li>The <strong>training objective</strong> is to maximize the likelihood of t he training data. This is manifested as tuning the model parameters to <strong>minimize the variational upper bound of the negative log likelihood of the data</strong>.</li>
  <li>Almost all terms in the objective function can be cast as <strong>KL Divergences</strong> as a result of the Markov assumption. This values <strong>become tenable to calculated</strong> given that we are using Gaussians, therefore omitting the need to perform MonteCarlo approximation.</li>
  <li>A discrete decoder is used to obatin log likelihoods across pixel values as the last step in the reverse diffusion process.</li>
</ol>


  </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;">
  <script>
    let giscusTheme = localStorage.getItem("theme");
    let giscusAttributes = {
        "src": "https://giscus.app/client.js",
        "data-repo": "LiGuiye/LiGuiye.github.io",
        "data-repo-id": "R_kgDOInph-Q",
        "data-category": "Announcements",
        "data-category-id": "DIC_kwDOInph-c4CTGBO",
        "data-mapping": "title",
        "data-strict": "0",
        "data-reactions-enabled": "1",
        "data-emit-metadata": "0",
        "data-input-position": "bottom",
        "data-theme": giscusTheme,
        "data-lang": "en",
        "crossorigin": "anonymous",
        "async": "",
    };


    let giscusScript = document.createElement("script");
    Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
    document.getElementById("giscus_thread").appendChild(giscusScript);
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a>
</noscript>
</div>
</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2022 Guiye  Li. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-50GRRBDLH3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ window.dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-50GRRBDLH3');
  </script>
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
